<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>성균관대 감귤학과 입학률 테스트 🍊</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #000;
    font-family: 'Pretendard', sans-serif;
  }

  #gameCanvas {
    display: block;
    width: 100vw;
    height: 100vh;
    background-color: black;
  }

  #startScreen, #resultScreen {
    position: absolute;
    inset: 0;
    background: url('backchar/SKKUpaper.jpg') no-repeat center center/cover;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    text-shadow: 2px 2px 5px black;
    z-index: 5;
  }

  h1 {
    font-size: 2em;
    margin-bottom: 1em;
  }

  .btn {
    background-color: orange;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 14px 24px;
    font-size: 1.2em;
    margin: 8px;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(255,165,0,0.6);
  }

  #countdown {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 8em;
    font-weight: 900;
    color: orange;
    text-shadow: 3px 3px 10px black;
    display: none;
    z-index: 10;
  }

  #timerCanvas {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 2;
  }
</style>
</head>
<body>

<div id="startScreen">
  <h1>성균관대 감귤학과 입학률 테스트 🍊</h1>
  <button class="btn" id="startBtn">시작하기</button>
</div>

<canvas id="gameCanvas"></canvas>
<canvas id="timerCanvas" width="100" height="100"></canvas>
<div id="countdown">3</div>

<div id="resultScreen" style="display:none;">
  <h1 id="resultText"></h1>
  <button class="btn" id="restartBtn">다시하기</button>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const timerCanvas = document.getElementById('timerCanvas');
const tctx = timerCanvas.getContext('2d');

const startScreen = document.getElementById('startScreen');
const countdownEl = document.getElementById('countdown');
const resultScreen = document.getElementById('resultScreen');
const resultText = document.getElementById('resultText');

let charImg = new Image();
let orangeImg = new Image();
let bombImg = new Image();
let bgImg = new Image();

let character, oranges, bombs, score, timeLeft, gameRunning;

// ✅ 이미지 미리 로딩
function preloadImages(callback) {
  let loaded = 0;
  const total = 4;
  const checkLoaded = () => {
    loaded++;
    if (loaded === total) callback();
  };
  charImg.src = 'backchar/char.png';
  orangeImg.src = 'backchar/mandarin.png';
  bombImg.src = 'backchar/Bomb.png';
  bgImg.src = 'backchar/SKKUpaper.jpg';

  charImg.onload = checkLoaded;
  orangeImg.onload = checkLoaded;
  bombImg.onload = checkLoaded;
  bgImg.onload = checkLoaded;
}

// ✅ 카운트다운
function showCountdown(seconds, callback) {
  let count = seconds;
  countdownEl.textContent = count;
  countdownEl.style.display = 'block';
  const interval = setInterval(() => {
    count--;
    if (count > 0) {
      countdownEl.textContent = count;
    } else {
      clearInterval(interval);
      countdownEl.style.display = 'none';
      callback();
    }
  }, 1000);
}

// ✅ 초기화
function resetGame() {
  character = { x: canvas.width / 2 - 50, y: canvas.height - 120, width: 100, height: 100 };
  oranges = [];
  bombs = [];
  score = 0;
  timeLeft = 30;
  gameRunning = false;
}

// ✅ 아이템 생성
function spawnItem() {
  if (!gameRunning) return;
  const isOrange = Math.random() < 0.7;
  const obj = {
    x: Math.random() * (canvas.width - 50),
    y: -50,
    speed: isOrange ? 5 : 6,
    type: isOrange ? 'orange' : 'bomb'
  };
  if (isOrange) oranges.push(obj);
  else bombs.push(obj);
  setTimeout(spawnItem, 600 + Math.random() * 400);
}

// ✅ 타이머
function drawTimer() {
  tctx.clearRect(0, 0, 100, 100);
  const radius = 40;
  const endAngle = (1 - timeLeft / 30) * 2 * Math.PI;

  // 색상 채우기 (시계 방향)
  tctx.beginPath();
  tctx.arc(50, 50, radius, -Math.PI / 2, endAngle - Math.PI / 2, false);
  tctx.strokeStyle = 'orange';
  tctx.lineWidth = 8;
  tctx.stroke();

  // 시침 (반시계 방향)
  const handAngle = -Math.PI / 2 - endAngle;
  tctx.beginPath();
  tctx.moveTo(50, 50);
  tctx.lineTo(50 + radius * Math.cos(handAngle), 50 + radius * Math.sin(handAngle));
  tctx.strokeStyle = '#fff';
  tctx.lineWidth = 3;
  tctx.stroke();

  tctx.font = 'bold 16px sans-serif';
  tctx.fillStyle = 'white';
  tctx.textAlign = 'center';
  tctx.fillText(`${timeLeft}s`, 50, 55);
}

// ✅ 게임 루프
function gameLoop() {
  if (!gameRunning) return;
  ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

  // 귤
  oranges.forEach(o => {
    o.y += o.speed;
    ctx.drawImage(orangeImg, o.x, o.y, 50, 50);
    if (checkCollision(o, character)) {
      score++;
      o.y = canvas.height + 100;
    }
  });

  // 폭탄
  bombs.forEach(b => {
    b.y += b.speed;
    ctx.drawImage(bombImg, b.x, b.y, 50, 50);
    if (checkCollision(b, character)) {
      score = Math.max(0, Math.floor(score / 2));
      b.y = canvas.height + 100;
    }
  });

  oranges = oranges.filter(o => o.y < canvas.height);
  bombs = bombs.filter(b => b.y < canvas.height);

  ctx.drawImage(charImg, character.x, character.y, character.width, character.height);
  drawTimer();

  if (timeLeft > 0) requestAnimationFrame(gameLoop);
  else endGame();
}

// ✅ 충돌 판정
function checkCollision(a, b) {
  return (
    a.x < b.x + b.width &&
    a.x + 50 > b.x &&
    a.y < b.y + b.height &&
    a.y + 50 > b.y
  );
}

// ✅ 게임 시작
function startGame() {
  startScreen.style.display = 'none';
  resetGame();
  showCountdown(3, () => {
    gameRunning = true;
    spawnItem();
    gameLoop();
    const timer = setInterval(() => {
      if (!gameRunning) {
        clearInterval(timer);
        return;
      }
      timeLeft--;
    }, 1000);
  });
}

// ✅ 게임 종료
function endGame() {
  gameRunning = false;
  resultScreen.style.display = 'flex';
  resultText.textContent = `🎓 당신의 감귤학과 입학률은 ${(score / 50 * 73).toFixed(1)}%입니다!`;
}

// ✅ 조작 (모바일 터치)
document.addEventListener('touchmove', e => {
  if (!character) return;
  const touch = e.touches[0];
  character.x = touch.clientX - character.width / 2;
});

// ✅ 버튼 이벤트
document.getElementById('startBtn').onclick = () => {
  preloadImages(() => {
    startGame();
  });
};

document.getElementById('restartBtn').onclick = () => {
  resultScreen.style.display = 'none';
  startGame();
};
</script>

</body>
</html>
